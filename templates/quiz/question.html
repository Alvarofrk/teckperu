{% extends "base.html" %}
{% load i18n %}

{% block title %} {{ quiz.title }} | {% trans 'Sistema de gesti√≥n de aprendizaje' %} {% endblock %}
{% block description %} {{ quiz.title }} - {{ quiz.description }} {% endblock %}

{% block extra_css %}
<style>
/* Estilos espec√≠ficos para p√°ginas de examen - PREVENCI√ìN TOTAL */
body[data-exam-page="true"] {
    /* Prevenir cualquier bloqueo */
    overflow: auto !important;
}

body[data-exam-page="true"] #top-navbar {
    /* Prevenir que el navbar se bloquee */
    pointer-events: auto !important;
    opacity: 1 !important;
    z-index: 1001 !important;
}

body[data-exam-page="true"] #top-navbar.dim {
    /* Anular completamente la clase dim en p√°ginas de examen */
    opacity: 1 !important;
    pointer-events: auto !important;
    box-shadow: 0 4px 20px var(--navbar-shadow) !important;
    background: linear-gradient(135deg, var(--navbar-bg) 0%, var(--navbar-bg-hover) 100%) !important;
}

body[data-exam-page="true"] #side-nav {
    /* Mantener sidebar funcional */
    pointer-events: auto !important;
    z-index: 1000 !important;
}

body[data-exam-page="true"] #main-content {
    /* Mantener contenido principal funcional */
    pointer-events: auto !important;
    z-index: 1 !important;
}

body[data-exam-page="true"] #quiz-form {
    /* Asegurar que el formulario sea completamente interactivo */
    pointer-events: auto !important;
    z-index: 1060 !important;
    position: relative !important;
}

body[data-exam-page="true"] #quiz-form * {
    /* Todos los elementos del formulario deben ser interactivos */
    pointer-events: auto !important;
}

body[data-exam-page="true"] #submit-btn {
    /* Bot√≥n de env√≠o con m√°xima prioridad */
    pointer-events: auto !important;
    cursor: pointer !important;
    z-index: 1070 !important;
    position: relative !important;
}

/* Prevenir que cualquier elemento bloquee la interactividad */
body[data-exam-page="true"] *[style*="pointer-events: none"] {
    pointer-events: auto !important;
}

body[data-exam-page="true"] *[style*="z-index: -1"] {
    z-index: auto !important;
}

/* Asegurar que el campo de b√∫squeda no cause problemas */
body[data-exam-page="true"] #primary-search {
    pointer-events: auto !important;
}

/* Prevenir overlays problem√°ticos */
body[data-exam-page="true"] *[style*="box-shadow: 0 0 0 10000px"] {
    box-shadow: none !important;
}

body[data-exam-page="true"] *[style*="box-shadow: 0 0 0 100vmax"] {
    box-shadow: none !important;
}

/* Instrucciones integradas en la p√°gina */
.exam-instructions {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.exam-instructions h5 {
    color: #007bff;
    margin-bottom: 10px;
    font-weight: 600;
}

.exam-instructions p {
    margin-bottom: 8px;
    color: #495057;
}

.exam-instructions ul {
    margin-bottom: 0;
    padding-left: 20px;
}

.exam-instructions li {
    color: #495057;
    margin-bottom: 5px;
}
</style>
{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
	<ol class="breadcrumb">
		<li class="breadcrumb-item"><a href="/">{% trans 'Inicio' %}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'programs' %}">{% trans 'Programas' %}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'program_detail' course.program.id %}">{{ course.program }}</a></li>
		<li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'quiz_index' course.slug %}">{% trans 'Cuestionarios' %}</a></li>
		<li class="breadcrumb-item active" aria-current="page">{{ quiz.title|title }}</li>
	</ol>
</nav>

<div class="title-1">Examen Final</div>
<br>

<div class="container">

	{% if previous.answers %}

	<p class="muted"><small>{% trans "La pregunta anterior" %}:</small></p>
	<p>{{ previous.previous_question }}</p>

	{% if previous.previous_outcome %}
		<div class="alert alert-success">
	{% else %}
		<div class="alert alert-warning">
	{% endif %}
		<p class="mb-0"><small>
			{% trans "Tu respuesta fue" %} </small>
			<strong>
			{{ previous.previous_outcome|yesno:"correcta,incorrecta" }}
			</strong>
		</p>

		</div>
		
        {% load i18n %}
        {% if previous.answers %}
          <table class="table table-striped table-bordered">
            <tbody>
              {% for answer in previous.answers %}
                {% if answer.correct %}
                  <tr class="success">
                    <td>{{ answer }}</td>
                  <td class="text-success"><strong>{% trans "Esta es la respuesta correcta" %}</strong></td>
				  </tr>
                {% else %}
                  <tr>
                    <td>{{ answer }}</td>
                    <td>
                    {% if previous.question_type.MCQuestion %}
                      {% if answer.id|add:"0" == previous.previous_answer|add:"0" %}
                        {% trans "Esta fue tu respuesta." %}
                      {% endif %}
                    {% endif %}
                    </td>
                  {% endif %}
                  </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if user_was_incorrect %}
            <div class="text-danger">
              <strong>{% trans "Respondiste incorrectamente a la pregunta anterior" %}</strong>
            </div>
          {% endif %}

        {% endif %}
		

        <p><strong>{% trans "Explicaci√≥n" %}:</strong></p>
        <p class="p-2" style="background-color: #fcf8e3;">
          {% if previous.previous_question.explanation %}
            {{ previous.previous_question.explanation }}
          {% else %}
            {% trans "No hay explicaci√≥n establecida para esta pregunta." %}
          {% endif %}
		</p>
		
		<hr>

	{% endif %}

	<br />

	{% if question %}

	{% if progress.0|add:1 == 1 %}
	<!-- INSTRUCCIONES INTEGRADAS EN LA P√ÅGINA - SIN MODAL -->
	<div class="exam-instructions">
		<h5><i class="fas fa-info-circle"></i> {% trans 'Instrucciones del examen' %}</h5>
		<p><strong>{% trans 'Importante:' %}</strong></p>
		<ul>
			<li>{% trans 'Lee cuidadosamente cada pregunta antes de responder' %}</li>
			<li>{% trans 'No puedes volver a la pregunta anterior despu√©s de enviarla' %}</li>
			<li>{% trans 'Verifica tu respuesta antes de proceder a la siguiente' %}</li>
			<li>{% trans 'Una vez que env√≠es tu respuesta, no podr√°s cambiarla' %}</li>
		</ul>
		<p class="mb-0"><small class="text-muted">{% trans 'Haz clic en "Verificar" cuando est√©s seguro de tu respuesta.' %}</small></p>
	</div>
	{% endif %}

	{% if progress %}
	<div class="text-light rounded small px-2 bg-danger" style="float: right;">
	{% trans "Pregunta" %} {{ progress.0|add:1 }} {% trans "de" %} {{ progress.1 }}
	</div>
	{% endif %}

	<p>
		<small class="muted">{% trans "Categor√≠a del cuestionario" %}:</small>
		<strong>"Examen"</strong>
	</p>

	<div class="card">
		<div class="lead p-2">
			<strong>{% trans "Pregunta" %} {{ progress.0|add:1 }}:</strong> {{ question.content }}
		</div>
	
		{% if question.figure %}
		<div class="col-md-8 mx-auto">
			<img class="q-img" src="{{ question.figure.url }}" alt="{{ question.content }}" style="max-width: 100%;"/>
		</div>
		{% endif %}
	
		<div class="card-subtitle p-4">
			<form action="" method="POST" id="quiz-form">{% csrf_token %}
				<input type="hidden" name="question_id" value="{{ question.id }}">
	
				<ul class="list-group">
					{% for answer in form.answers %}
					<li class="list-group-item">
						<strong>{{ forloop.counter }}.</strong> {{ answer }}
					</li>
					{% endfor %}
				</ul>
				<br>
				<input type="submit" value="{% trans "Verificar" %}" class="btn btn-large btn-block btn-primary" id="submit-btn" />
			</form>
		</div>

		{% endif %}
	</div>

</div>

{% endblock %}

{% block js %}
<script>
// ===== SISTEMA DE PROTECCI√ìN SIMPLIFICADO PARA P√ÅGINAS DE EXAMEN =====

// Marcar esta p√°gina como p√°gina de examen inmediatamente
document.body.setAttribute('data-exam-page', 'true');

// Funci√≥n principal de protecci√≥n simplificada
function setupExamProtection() {
    console.log('üõ°Ô∏è Configurando protecci√≥n simplificada para p√°gina de examen...');
    
    // 1. DESHABILITAR COMPLETAMENTE LA CLASE DIM
    disableDimClass();
    
    // 2. PROTEGER EL FORMULARIO
    protectQuizForm();
    
    // 3. DESHABILITAR EVENTOS PROBLEM√ÅTICOS
    disableProblematicEvents();
    
    // 4. CONFIGURAR MONITOREO CONTINUO
    setupContinuousMonitoring();
    
    console.log('‚úÖ Protecci√≥n de examen configurada correctamente');
}

// Funci√≥n para deshabilitar completamente la clase dim
function disableDimClass() {
    const topNavbar = document.getElementById('top-navbar');
    if (topNavbar) {
        // Remover clase dim si existe
        topNavbar.classList.remove('dim');
        
        // Crear un observer para prevenir que se agregue la clase dim
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (topNavbar.classList.contains('dim')) {
                        topNavbar.classList.remove('dim');
                        console.log('üõ°Ô∏è Clase dim removida autom√°ticamente');
                    }
                }
            });
        });
        
        observer.observe(topNavbar, { attributes: true });
        
        // Aplicar estilos de protecci√≥n
        topNavbar.style.opacity = '1';
        topNavbar.style.pointerEvents = 'auto';
        topNavbar.style.zIndex = '1001';
    }
}

// Funci√≥n para proteger el formulario
function protectQuizForm() {
    const quizForm = document.getElementById('quiz-form');
    const submitBtn = document.getElementById('submit-btn');
    
    if (quizForm) {
        // Asegurar que el formulario sea completamente interactivo
        quizForm.style.pointerEvents = 'auto';
        quizForm.style.zIndex = '1060';
        quizForm.style.position = 'relative';
        
        // Asegurar que todos los elementos del formulario sean interactivos
        const formElements = quizForm.querySelectorAll('*');
        formElements.forEach(function(element) {
            element.style.pointerEvents = 'auto';
        });
        
        // Prevenir env√≠o m√∫ltiple
        quizForm.addEventListener('submit', function(e) {
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.value = 'Procesando...';
            }
        });
    }
    
    if (submitBtn) {
        submitBtn.style.pointerEvents = 'auto';
        submitBtn.style.cursor = 'pointer';
        submitBtn.style.zIndex = '1070';
        submitBtn.style.position = 'relative';
    }
}

// Funci√≥n para deshabilitar eventos problem√°ticos
function disableProblematicEvents() {
    // Deshabilitar eventos del campo de b√∫squeda
    const searchInput = document.getElementById('primary-search');
    if (searchInput) {
        // Remover todos los event listeners existentes
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Prevenir que se agreguen nuevos eventos problem√°ticos
        newSearchInput.addEventListener('focus', function(e) {
            e.stopPropagation();
            // NO hacer nada que pueda bloquear la p√°gina
        });
        
        newSearchInput.addEventListener('blur', function(e) {
            e.stopPropagation();
            // NO hacer nada que pueda bloquear la p√°gina
        });
    }
}

// Funci√≥n para configurar monitoreo continuo
function setupContinuousMonitoring() {
    // Monitorear continuamente para prevenir bloqueos
    setInterval(function() {
        // Verificar que la clase dim no est√© presente
        const topNavbar = document.getElementById('top-navbar');
        if (topNavbar && topNavbar.classList.contains('dim')) {
            topNavbar.classList.remove('dim');
        }
        
        // Verificar que el formulario sea interactivo
        const quizForm = document.getElementById('quiz-form');
        if (quizForm && quizForm.style.pointerEvents !== 'auto') {
            quizForm.style.pointerEvents = 'auto';
        }
        
        // Verificar que el bot√≥n de env√≠o sea interactivo
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn && submitBtn.style.pointerEvents !== 'auto') {
            submitBtn.style.pointerEvents = 'auto';
            submitBtn.style.cursor = 'pointer';
        }
    }, 1000);
}

// Inicializar protecci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando protecci√≥n de examen...');
    setupExamProtection();
});

// Inicializar protecci√≥n tambi√©n inmediatamente si el DOM ya est√° listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupExamProtection);
} else {
    setupExamProtection();
}

// Hacer funci√≥n disponible globalmente
window.setupExamProtection = setupExamProtection;

console.log('üõ°Ô∏è Sistema de protecci√≥n de examen cargado (sin modal)');
</script>
{% endblock js %}